\chapter{Control System Implementation}
\label{implementation_of_controller}

This chapter will explain how the controller designed in \chapref{Controller} is implemented on the system at Aalborg university.  

\section{Simulink implementation}
\label{simulink_intro}
In the implementation of the control the model estimated in \secref{estim_results} is used. Although, the fit percentage with differs from the real data the behavior and dynamics of the WT are correctly caught, making this model the most suitable one to work with. 
% It is worth mentioning, that for the implementation of the control, the second linear model attempt is used as it is the most suitable model to work with. The MPC controller is implemented in MATLAB Simulink, which is connected to the model as shown in \figref{fig:control_sketch}:

\begin{figure}[H]
\centering
\input{report/tikz/Control_Layout.tex} 
\caption{Sketch of the control implementation.}
\label{fig:control_sketch}
\end{figure}

From the state-space model the WT pressure is sent to the MPC, as the current state takes part both in the optimization of the problem and in the constraints.

In order to solve the MPC and find a global minimum for the problem specified in \eqref{eq:obj_final1},  MATLABs quadratic solver, \textit{quadprog}, is used. This solver, finds out the preceding problem subject to the specified constraints and restrictions set to the convex function. The interior-point-convex algorithm is chosen to carry out the calculation of the control inputs. This algorithm solves the problem by simplifying the constraints, and then and then by iterating in the interior of the feasible set, progressively adds the constraint and reconstructs the original problem \cite{Convex_optimization}. 



In previous sections the number of predictions, $H_p$, is introduced. It is decided to predict 24 hour forward due to the periodicity of the daily rhythm of the population. Therefore, the control input to the state-space model and the disturbance added by the end-users consumption are updated every hour. The sampling time for the control input will differ from the sample time determined for the state space model, which is $T_s = 87.5s$. 

In \appref{sec:cost_fkt}, the electric price model is shown. Nevertheless, for the implementation of the control not only the electric price model is needed but also a model for the end-users water consumption. This can be seen on \figref{fig:water_consumption}

\begin{figure}[H]
\centering
\input{report/tikz/OD_consumption.tex} 
\caption{End-users water consumption, with acts as a disturbance to the system.}
\label{fig:water_consumption}
\end{figure}

The end-users are assumed to have a periodic behavior in the water consumption. In this case the model is made to lasts a week day and then repeats. 


\section{Simulink results}

After implementing the MPC, described in \secref{simulink_intro}, multiple complications occurred. The optimization problem deemed convex in \secref{convexity} seemed to be infeasible. As a results of this no minimum was found. MUltiple attempts to solve this problem was done and 


\begin{figure}[H]
\centering
\input{report/tikz/Implementation_shit.tex} 
\caption{Implemented optimizer, without constraints, that give a wrong behavior. Pump one can be seen in red and pump two as blue.}
\label{fig:Implementation_shit}
\end{figure}
