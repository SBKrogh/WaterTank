\chapter{Control System Implementation}
\label{implementation_of_controller}

This chapter will explain how the controller designed in \chapref{Controller} is implemented on the scaled system at Aalborg university.  

\section{Simulink implementation}
\label{simulink_intro}
In the implementation of the control the model estimated in \secref{estim_results} is used. Although, the fit percentage differs from the real data the behavior and dynamics of the WT are correctly caught, making this model the most suitable one to work with. 
% It is worth mentioning, that for the implementation of the control, the second linear model attempt is used as it is the most suitable model to work with. The MPC controller is implemented in MATLAB Simulink, which is connected to the model as shown in \figref{fig:control_sketch}:

\begin{figure}[H]
\centering
\input{report/tikz/Control_Layout.tex} 
\caption{Sketch of the control implementation.}
\label{fig:control_sketch}
\end{figure}

From the state-space model the WT pressure is sent to the MPC, as the current state takes part both in the optimization of the problem and in the constraints.

In order to solve the MPC and find a global minimum for the problem specified in \eqref{eq:obj_final1},  MATLABs quadratic solver, \textit{quadprog}, is used. This solver, finds out the preceding problem subject to the specified constraints and restrictions set to the convex function. The interior-point-convex algorithm is chosen to carry out the calculation of the control inputs. This algorithm solves the problem by simplifying the constraints, and then and then by iterating in the interior of the feasible set, progressively adds the constraint and reconstructs the original problem \cite{Convex_optimization}. 



In previous sections the number of predictions, $H_p$, is introduced. It is decided to predict 24 hour forward due to the periodicity of the daily rhythm of the population. Therefore, the control input to the state-space model and the disturbance added by the end-users consumption are updated every hour. The sampling time for the control input will differ from the sample time determined for the state space model, which is $T_s = 87.5s$. 

In \appref{sec:cost_fkt}, the electric price model is shown. Nevertheless, for the implementation of the control not only the electric price model is needed but also a model for the end-users water consumption. This can be seen on \figref{fig:water_consumption}

\begin{figure}[H]
\centering
\input{report/tikz/OD_consumption.tex} 
\caption{End-users water consumption, with acts as a disturbance to the system.}
\label{fig:water_consumption}
\end{figure}

The end-users are assumed to have a periodic behavior in the water consumption. In this case the model is made to lasts a week day and then repeats. 


\section{Simulink results}
The MPC problem set up to optimize the power consumption of the pumps, developed through \secref{sec:MPC}, has been proved to be convex. In this way, the main feature of this controller is the ability to reduce the cost of running th system based on the electric price and the WT level. 

After implementing the MPC, described in \secref{simulink_intro}, multiple complications occurred. The optimization problem deemed convex is, at first, implemented with only the input constraints. This is done to check that the simpler optimization problem can be solved. The input constraints are added to guarantee that pumps do not run outside their physical limits. 

Since there are no constraints applied to either the pressure at the WT or the CP, it is expected to see that the input signal is as low as possible the whole time. This behavior, compared to the real system, is expected because the cheapest way of running the pumps would be as slow as possible. 

\begin{figure}[H]
\centering
\input{report/tikz/Implementation_shit.tex} 
\caption{Implemented optimizer, without constraints. The first figure show the two pumps, pump one can be seen in red and pump two as blue. The second figure shows the cost of electricity for the first 24 hours.}
\label{fig:Implementation_shit}
\end{figure}

On \figref{fig:Implementation_shit} the electrical price and both input signal to the pumps can be seen. Here it can be seen that the input to the first pump is constant at $0.05$ and $0.03$, the lower bounds for the pumps respectively. If an input signal lower then this is applied to the pumps they will start acting unstable. 

Then the other constraints, to the pressure at the WT and the CP, is added and then no infeasible solution is found. This is also the case then only one of the constraint are added. 

This could occur because the model, used in the implementation is simplification of the real world. In order to set up the constraints for the optimizing problem, the physical limitations of the system setup have been determined. These values are obtained under the operating point conditions of the system, so that they remain under reasonable regions for the linearized model. Nevertheless, these values would be feasible for the estimated model if and only if the model had represented the real setup perfectly. As described in \secref{estim_results} the estimation has been carried out so the dynamics of the WT are prioritized rather than obtaining a closer fit percentage for the model. Therefore, the physical limits calculated for the real setup cannot be utilized for the simulation model, making the quadratic problem to be infeasible within the specified constraints. This infeasibility means that not all constraints can be satisfied at a single solution $\bm{u}$.

%\subsection{Summary of implementation}
%The MPC, from \chapref{Controller}, is tried implemented and seems to be work at first. 


%seemed to be infeasible. As a results of this no minimum was found. MUltiple attempts to solve this problem was done and 

%
% vis at vores optimering virker når vi kun bruger lb og ub. Dog kan det ses at intputet stiger når prisen stiger, hvilket kunne tyde på en fortegnsfejl
%
% Når vi tilføjer flere constrints går det helt galt og problemet er infeasible  
%
%
%
