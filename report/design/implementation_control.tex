\chapter{Control System Implementation}
\label{implementation_of_controller}

This chapter will explain how the controller designed in \chapref{Controller} is implemented on the scaled system at Aalborg university.  

\section{Simulink implementation}
\label{simulink_intro}
In the implementation of the control, the model estimated in \secref{estim_results} is used. Although, the fit percentage differs from the real data, the behavior and dynamics of the WT are correctly caught, making this model the most suitable and realistic to work with. \figref{fig:control_sketch} shows the implementation strategy for the control design on the model of the water distribution system.
% It is worth mentioning, that for the implementation of the control, the second linear model attempt is used as it is the most suitable model to work with. The MPC controller is implemented in MATLAB Simulink, which is connected to the model as shown in \figref{fig:control_sketch}:

\begin{figure}[H]
\centering
\input{report/tikz/Control_Layout.tex} 
\caption{Sketch of the control implementation.}
\label{fig:control_sketch}
\end{figure}

From the state-space model, the WT pressure is sent to the MPC block at each iteration, as the current initial state is measured and required for calculating the constraints and the objective function. 

In order to solve the optimization problem and find a global minimum for the problem specified in \eqref{eq:obj_final1},  Quadratic Programming(QP) is used. Solvers for QP problems in Matlab find out the preceding problem subject to the specified constraints and restrictions set to the convex function. The method chosen is interior-point-convex algorithm which solves the problem by simplifying the constraints and then by iterating in the interior of the feasible set.  Progressively, it adds the constraints and reconstructs the original problem \cite{Convex_optimization}. 

In previous sections, the length of the prediction horizon, $H_p$, is introduced. It is decided to predict 24 hour forward due to the periodicity of the electricity price and the behavior of the end-user consumption. Therefore, the control input to the state-space model and the disturbance due to the end-users are updated every hour. The sampling time for the control input will differ from the sample time determined for the discrete time state-space model, which is $T_s = 87.5s$. 

In \appref{sec:cost_fkt}, the electric price model is shown. Nevertheless, for the implementation of the control not only the electric price model is needed but also a model for the end-user water consumption. This can be seen in \figref{fig:water_consumption}

\begin{figure}[H]
\centering
\input{report/tikz/OD_consumption.tex} 
\caption{End-users water consumption, with acts as a disturbance to the system.}
\label{fig:water_consumption}
\end{figure}

In this case the model is created to last for a week and then repeats. 


\section{Simulink results}
The objective function set up to optimize the power consumption of the pumps, developed through \secref{sec:MPC}, has been proved to be convex, in \secref{convexity}. 

%In this way, the main feature of this controller is the ability to reduce the cost of running the system based on the electric price and the WT level. 

Although the objective function for the minimization is convex, difficulties with infeasibility occurred while solving the constrained problem. Infeasibility means that no solution of $\bm{u_{hp}}$ exists which could satisfy all the constraints defined by the measurements on the test setup. The QP solver detects this problem automatically at the presolve phase of each optimization run, thus the MPC box in the block diagram gives no solution in these cases. As it is mentioned in \secref{verification_of_model}, the model is verified, however in some respects lacks the ability to give back the real-world behavior of the system. As described in \secref{estim_results}, the estimation has been carried out so the dynamics of the WT are reflect the same behavior as the real-world system. However, the model does not fit perfectly. The physical limits calculated for the real setup cannot be utilized for the simulation model, making the quadratic problem to be infeasible within the specified constraints. The physical limitations of the system setup have been determined such that they are obtained under the operating point values, so that they remain under reasonable regions for the linearized model. However, the constraints introduced for the pressure in the WT and the output pressure for the end-users make the problem infeasible. 

For initial testing, the MPC is implemented such that only the constraint on the input is kept with the appropriate low and great bounds. An implementation of such would make no sense on the test setup since the constraints on the water tower are the most important limits concerning this control problem. In a real life scenario, leaving out the pressure constraint in the WT would mean that the optimal input empties the tank, disregarding what the price is. However, this test is suitable for verifying if the minimization works correctly or not.Therefore it is expected to see that the input signal is constant and as low as possible during operation. This behavior, compared to the real system, is expected because the cheapest way of running the pumps would be as slow as possible. 

\begin{figure}[H]
\centering
\input{report/tikz/Implementation_shit.tex} 
\caption{Implemented optimizer, without constraints. The first figure show the two pumps, pump one can be seen in red and pump two in blue. The second figure shows the cost of electricity for the first 24 hours.}
\label{fig:Implementation_shit}
\end{figure}

In \figref{fig:Implementation_shit} it can be seen that the full-signal input to the first pump is constant at $0.05$ and $0.03$, for the two different the lower bounds of the pumps, respectively. Constraints on the pumps are set in order to avoid the lower bound hysteresis of the pumps and to not exceed the maximal available upper bound. 

The remaining constraints, consisting of the pressure at the WT and the CP, are added and consequently no feasible solution is found. This is also the case when only one of the constraint is added. 

This could occur because the model, used in the implementation is simplification of the real world. In order to set up the constraints for the optimizing problem, the physical limitations of the system setup have been determined. These values are obtained under the operating point conditions of the system, so that they remain under reasonable regions for the linearized model. Nevertheless, these values would be feasible for the estimated model if and only if the model had represented the real setup perfectly. As described in \secref{estim_results} the estimation has been carried out so the dynamics of the WT are prioritized rather than obtaining a closer fit percentage for the model. Therefore, the physical limits calculated for the real setup cannot be utilized for the simulation model, making the quadratic problem to be infeasible within the specified constraints. This infeasibility means that not all constraints can be satisfied at a single solution $\bm{u}$.

The optimizing problem design is hereby finished as the MPC control has been implemented together with the estimated model. On the one hand, it is shown that the unconstrained problem is solvable and expected values are obtained. On the other hand, the problem cannot be completed due to the incapability to calculate a control input once the constraints of the system are set. Any further discussion on the subject is brought up in the following chapter. 

%\subsection{Summary of implementation}
%The MPC, from \chapref{Controller}, is tried implemented and seems to be work at first. 


%seemed to be infeasible. As a results of this no minimum was found. MUltiple attempts to solve this problem was done and 

%
% vis at vores optimering virker når vi kun bruger lb og ub. Dog kan det ses at intputet stiger når prisen stiger, hvilket kunne tyde på en fortegnsfejl
%
% Når vi tilføjer flere constrints går det helt galt og problemet er infeasible  
%
%
%
