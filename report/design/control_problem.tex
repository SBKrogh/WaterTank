\section{Control Problem}
\label{control_problem}

The water distribution system explained in \secref{system_overview} need to be controlled according the \secref{Requirements_and_constraints}. The requirements can be summarized as: 

\begin{itemize}
	\item Pressure at CP, $0.08 < p_{cp} < 0.14 \:[\text{bar}]$
%
	\item Minimum water exchange , $\bar{q}_{wt} > 0.06 \: \big[\frac{m^3}{day}\big]$
%
	\item Minimizing the total cost of running the system
\end{itemize}

The WT is introduced to reduce the operation cost of the water distribution network. Therefor the system has to be controlled in a way that obtains the lowest cost of operation. 

Considering both the model of the water distribution network, cost function for the pumps and the constrains , this leads to a description of the systems operating area, $C_T(\pmb{\Delta{p}},\pmb{q})$ wherein the system must operate. By considering the total cost of running, $C_T$ this can be seen as a minimization problem:
\todo{inset network model in minimization problem}
\begin{align*}
\underset{\pmb{u}, \:\pmb{q}}{min} \: C_T(\pmb{\Delta{p}},\pmb{q}) &= \underset{u, \:q}{min} \: \sum_{i=1}^{N} Q_i(\Delta{p}_i,q_i) P_E  \\
%
s.t \:\:\:\:\: & Inset \:model \\
%
& \underline{p_{cp}} < \pmb{p_{cp}} < \overline{p_{cp}} \\
%
& \underline{p_{wt}} < \pmb{p_{wt}} < \overline{p_{wt}} \\
%
& \bar{q}_{wt} > \underline{\bar{q}_{wt}}
\end{align*}

 \begin{minipage}[t]{0.20\textwidth}
 Where\\
 \hspace*{8mm} $C_T(\Delta{p}_i,q_i)$ \\
 \hspace*{8mm} $Q_i(\Delta{p}_i,q_i)$ \\
 \hspace*{8mm} N \\
 \hspace*{8mm} $p_{cp}$ \\
 \hspace*{8mm}  \textcolor{White}{te}\\
 \hspace*{8mm} $p_{wt}$ \\
 \hspace*{8mm}  \textcolor{White}{te}\\
 \hspace*{8mm} $P_E$ \\
  and \hspace*{0.7mm} $\bar{q}_{wt}$	
 \end{minipage}
 \begin{minipage}[t]{0.68\textwidth}
 \vspace*{2mm}
 is the cost of running the system, \\
 is the power consumption of the $i^{th}$ pump,\\
 is the number of pumps,\\
 is the pressure at a given CP, $\overline{p_{cp}}$ and $\underline{p_{cp}}$ are the upper and lower bounds,\\
 is the pressure at the WT outlet, $\overline{p_{wt}}$ and $\underline{p_{wt}}$ are the upper and lower bounds,\\
 is the price of electricity,\\ 
 is the average flow rate through the WT, $\underline{\bar{q}_{wt}}$ is the lower bound.
 \end{minipage}
 \begin{minipage}[t]{0.10\textwidth}
 \vspace*{2mm}
 \textcolor{White}{te}$\unit{\frac{DKK}{W}}$\\
 \textcolor{White}{te}$\unit{W}$\\
 \textcolor{White}{te}$\unit{\cdot}$\\
 \textcolor{White}{te}$\unit{Bar}$\\
 \hspace*{8mm}  \textcolor{White}{te}\\
 \textcolor{White}{te}$\unit{Bar}$\\
 \hspace*{8mm}  \textcolor{White}{te}\\
 \textcolor{White}{te}$\unit{DKK}$\\
  \textcolor{White}{te}$\unit{\frac{m^3}{day}}$
 \end{minipage}

From this the input vector $\pmb{u}$ should be obtained, so the cost of running the system, within the bounds of the constrains, is minimized. 


The system consists of four pumps, two local PMA pumps and two main pumps. Because the focus of this project is to balance between the mains pumps and the WT a simpler controller is implemented to keep a specific differential pressure over the PMA pumps.

A more advanced controller, controlling the main pumps, are designed to minimize the cost of running the system. This is done by using Model Predictive Control, MPC. The advantage of MPC, compared to eg. LQR is that the MPC can optimize a state keeping the expectation of the future into account. 

In the following sections the design of the descried control system is explained. 


%The purpose is to let the WT do the work when the price of running the pumps are high.

%\begin{align*}
%\pmb{B}
%\end{align*}


% The pressure at a given CP can be controlled by the water level in the WT which is controlled by the rotational speed of the pumps. To fulfill the requirement of a minimum pressure at a given CP the water level in the WT have to be within a operations area. A controller have to be develop that takes the pressure actuators into account. 

% The flow through the WT is controlled by pressure in the outer ring. Whenever the pressure is higher in the outer ring than in the WT, water is being pump into the WT. Furthermore the average flow rate, $\bar{q}_{wt}$, through the WT must meet the minimum requirement to insure the water quality. This can be seen as a constrain of the operation area of the system. 

% At the same time the total cost of running the system should be minimized. Therefor a cost function is needed. This cost function purpose is to find the optimal control signal which minimize the cost of running the pumps. Thereby spending the least money on running the total system. 