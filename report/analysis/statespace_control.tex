\section{State space model for control}
 \label{SystemLin_control}
 
For the sake of clarity the steady-state, state-space representation for the parameter estimation for small-signal values is restated here:
 
 \begin{equation}
 0 = \pmb{M} \pmb{\hat{z}} + \pmb{N} \pmb{\hat{u}} + \pmb{B_o} \Delta \hat{p}_{WT}    
 \label{statespace_param_sys}
\end{equation}

The equation for the outputs:

\begin{equation}
  \pmb{\hat{y}} = \pmb{C_p} \Delta \hat{p}_{WT} + \pmb{D_p} \pmb{\hat{u}} 
   \label{statespace_param_out}
\end{equation}

And the dynamic model of the WT pressure:

\begin{equation}
\Delta \dot{p}_{WT} = \frac{1}{C_H} q_0
 \label{WT_eq_repeat}
\end{equation}

Although \eqref{statespace_param_sys}, \eqref{statespace_param_out} and \eqref{WT_eq_repeat} include all the linearized terms that are necessary to describe the system, for the control it has being restructured. While the input vector for the parameter estimation consists of all the four pump differential pressures along with the four valve opening degrees, in case of the control, only the two main pumps are considered as inputs. The control input for the system is therefore defined as $\pmb{\hat{u}} \in \pmb{\mathbb{R}}^{(2 \times 1)}$ as follows: 

\begin{equation}
\pmb{\hat{u}} =
\begin{bmatrix} 
\Delta p_{e01} \\
\Delta p_{e08} 
\label{inputvector_control}
\end{bmatrix} 
\end{equation}

This distinction between the parameter estimation and the control is being made because of the different purposes. In case of the parameter estimation the inputs are set to excite the system in order to make different pressure scenarios in the network. Therefore the valve opening degrees and all pumps are controlled manually to create appropriate output measurements. These measurements are then used to achieve a fit with the output of the simulation by changing its parameters. However in the control this is not desired. Here the inputs are chosen for the control and therefore neither the valve opening degrees, nor the pump signals are varied manually. 

The mapping for the two main pump pressures yields:

\begin{equation}
\pmb{B_1} \alpha(\Delta p) = \pmb{B_1} \pmb{G_{c;1}} \pmb{\hat{u}}
\label{mapping_main}
\end{equation}

\begin{minipage}[t]{0.12\textwidth}
Where\\
\hspace*{8mm} $\pmb{G_{c;1}}$ 
\end{minipage}
\begin{minipage}[t]{0.12\textwidth}
\vspace*{2mm}$\in \pmb{\mathbb{R}}^{(e \times u)} $ 
\end{minipage}
\begin{minipage}[t]{0.74\textwidth}
\vspace*{2mm}
is a matrix representing a linear mapping between the vectorfield $\alpha(\Delta p)$, describing the pressure contribution of the pumps, and between the input vector defined in \eqref{inputvector_control} where the dimension $u$ is the number of inputs and $e$ is the number of edges without the WT. 
\end{minipage} 

$\pmb{G_{c;1}}$ is now a mapping matrix for only the two inputs for the main pumps. $\pmb{G_{c;1}}$ can be found in \todo{[appendix reference]}.

The input matrix for the control system can be written in the form: 

\begin{equation}
  \pmb{N_c} =  \pmb{B_1}\pmb{G_{c;1}}  
\label{inputmatrix_control}	
\end{equation}

Compared to the input matrix in the parameter estimation in \eqref{Bumatrix}, it can be seen that now the linearized terms belonging to the valves are not part of the matrix since valves are not considered as control inputs. 
\\
However, the end-user valves are considered as known disturbances in the control system. Therefore the disturbance is defined as $\pmb{d} \in \pmb{\mathbb{R}}^{(2 \times 1)}$ as follows: 

\begin{equation}
\pmb{d} =
\begin{bmatrix} 
OD_{e15} \\
OD_{e22} 
\label{disturbancevector_control}
\end{bmatrix} 
\end{equation}

%Therefore between $\alpha(dP)$, the vectorfield describing the pump pressure, and the disturbance vector the mapping results in the following:
%
%\begin{equation}
%\pmb{B_1} \alpha(DP) = \pmb{B_1} \pmb{G_{c;2}} \pmb{d}
%\label{mapping_PMA}
%\end{equation}
%
%\todo{minipage fix}
%
%\begin{minipage}[t]{0.30\textwidth}
%Where\\
%\hspace*{8mm} $\pmb{G_{c;2}} \in \pmb{\mathbb{R}}^{(e \times u)} $ 
%\end{minipage}
%\begin{minipage}[t]{0.68\textwidth}
%\vspace*{2mm}
%the dimension $d$ is the number of disturbances and $e$ is the number of edges without the WT. 
%\end{minipage} 
As can be seen, the PMA pumps are neither considered as inputs, nor as disturbances. The input for the PMA pumps is excluded in the linearized model for the reason that the system is described by deviation variables. It means that if the PMA pumps were included as disturbances, they would not have an effect on the linearized system because they are kept constant all the time. 
\\
The disturbance matrix for the state space model consists of the linearized terms of the end-user valves. The matrix can be formulated as follows: 

\begin{equation}
  \pmb{Q_c} = \pmb{B_1} \bigg[ \frac{\partial{\mu(\pmb{{B_1^{T}}}\pmb{z}, \pmb{OD})}}{{\partial{\pmb{d}}}}  \bigg]_{(\bar{z}, \bar{u})}  
\label{disturbance_matrix}
\end{equation}

Taking the same considerations into account as for the parameter estimation, the steady-state, state equation for small signals can be formulated as: 

 \begin{equation}
 0 = \pmb{M_c} \pmb{\hat{z}} + \pmb{N_c} \pmb{\hat{u}} + \pmb{Q_c} \pmb{\hat{d}} + \pmb{B_o} \Delta \hat{p}_{WT}    
 \label{statespace_control_sys}
\end{equation}

where the system matrix, $\pmb{M_c}$ is the same as the system matrix, $\pmb{M_p}$, in case the parameter estimation. 
\\
$\pmb{M_c}$ is invertible for the same reason as described in \eqref{Jequation}, thus:

 \begin{equation}
 \pmb{\hat{z}} =  - (\pmb{M_c^{-1}}\pmb{N_c}) \pmb{\hat{u}} - (\pmb{M_c^{-1}}\pmb{Q_c}) \pmb{\hat{d}} - (\pmb{M_c^{-1}}\pmb{B_o}) \Delta \hat{p}_{WT}    
 \label{statespace_control_sys_state}
\end{equation}

Inserting the states into \eqref{currentlaw_4}:

 \begin{equation}
\Delta \dot{\hat{p}}_{WT} = (\pmb{S}\pmb{M_c^{-1}}\pmb{B_o}) \Delta \hat{p}_{WT}  + (\pmb{S}\pmb{M_c^{-1}}\pmb{N_c}) \pmb{\hat{u}} + (\pmb{S}\pmb{M_c^{-1}}\pmb{Q_c}) \pmb{\hat{d}} 
 \label{statespace_control_sys_state_1}
\end{equation}

Which in standard state-space form can be written as: 

 \begin{equation}
\Delta \dot{\hat{p}}_{WT} = A_c \Delta \hat{p}_{WT}  + \pmb{B_c} \pmb{\hat{u}} + \pmb{E_c} \pmb{\hat{d}} 
 \label{statespace_control_sys_state_2}
\end{equation}

\begin{minipage}[t]{0.40\textwidth}
Where\\
\hspace*{8mm} $A_c = \pmb{S}\pmb{M_c^{-1}}\pmb{B_o} $ \\
\hspace*{8mm} $\pmb{B_c} = \pmb{S}\pmb{M_c^{-1}}\pmb{N_c} $ \\
\hspace*{8mm} $\pmb{E_c} = \pmb{S}\pmb{M_c^{-1}}\pmb{Q_c} $
\end{minipage}
\begin{minipage}[t]{0.48\textwidth}
\vspace*{1mm}
is the system matrix for the control, \\
is the input matrix for the control, \\
is the disturbance matrix for the control.
\end{minipage} 

The output of the control model is defined as two measurement points around the valves in the two different PMAs. Therefore the output vector is defined as: 

\begin{equation}
\pmb{y} =
\begin{bmatrix} 
\Delta p_{e15} \\
\Delta p_{e22} 
\label{outputvector_control}
\end{bmatrix} 
\end{equation}

Since the outputs are pressures around two end-user valves, the output expression should be written in the form:

\begin{equation}
  \pmb{\hat{y}} = \pmb{C_1} \pmb{\hat{z}} + \pmb{C_2} \pmb{\hat{d}}  
   \label{statespace_control_output}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $\pmb{C_1}$ \\
\newline
\newline
\newline
\hspace*{8mm} $\pmb{C_2}$ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
is the matrix consisting of the mapping between the vectorfield, $\mu$, and the output vector. Furthermore it includes the partial derivative matrix of the vectorfield according to the independent states, \\
is the matrix consisting of the mapping between the vectorfield, $\mu$, and the output vector. Furthermore it includes the partial derivative matrix of the vectorfield according to the ODs.
\end{minipage}

As it is shown, the output equation includes feedforward from the measured disturbances. 
\\
Expressing the independent flow variables with \eqref{statespace_control_sys_state}, the following yields: 

\begin{equation}
  \pmb{\hat{y}} = \pmb{C_1} \big[- (\pmb{M_c^{-1}}\pmb{N_c}) \pmb{\hat{u}} - (\pmb{M_c^{-1}}\pmb{Q_c}) \pmb{\hat{d}} - (\pmb{M_c^{-1}}\pmb{B_o}) \Delta \hat{p}_{WT}\big] + \pmb{C_2} \pmb{\hat{d}}  
   \label{statespace_control_output}
\end{equation}

And the output equation in standard state-space form:

\begin{equation}
  \pmb{\hat{y}} = \pmb{C_c} \Delta \hat{p}_{WT} + \pmb{D_c} \pmb{\hat{u}} + \pmb{K_c} \pmb{\hat{d}}
\label{statespace_control_output_standard}
\end{equation}

\begin{minipage}[t]{0.40\textwidth}
Where\\
\hspace*{8mm} $C_c = -\pmb{C_1}\pmb{M_c^{-1}}\pmb{B_o} $ \\
\hspace*{8mm} $\pmb{D_c} = - \pmb{C_1}\pmb{M_c^{-1}}\pmb{N_c} $ \\
\hspace*{8mm} $\pmb{K_c} = \pmb{C_2} -\pmb{C_1}\pmb{M_c^{-1}}\pmb{Q_c} $
\end{minipage}
\begin{minipage}[t]{0.48\textwidth}
\vspace*{1mm}
is the output matrix for the control, \\
is the feed-forward matrix for the control, \\
is the disturbance matrix affecting the output.
\end{minipage} 

The continuous state space representation thus given by \eqref{statespace_control_sys_state_2} and \eqref{statespace_control_output_standard}.

\subsection{Discretization of state space model}
 \label{discrete_SS}
 
The dynamics of the water distribution system are now described. To use this linear continuous model to be subjected to MPC, the model needs to be discretized by assuming zero-order-hold(ZOH) of the variables at specified sampling points. This means that the variables are constant between these points. The aim is to have a linear discrete-time state-space model with piecewise constant $\Delta \hat{p}_{WT}[k]$, $\pmb{\hat{u}}[k]$ and $\pmb{\hat{d}}[k]$. The method is chosen as forward Euler-method and the detailed presentation can be found in \appref{cha:discret_SS}. The final discretized state-space model is stated here with respect to the sampling time $T_s$: 

 \begin{equation}
\Delta \hat{p}_{WT} [k+1] = A_d \Delta \hat{p}_{WT}[k]  + \pmb{B_d} \pmb{\hat{u}}[k] + \pmb{E_d} \pmb{\hat{d}}[k] 
 \label{statespace_discrete_state}
\end{equation}

and the output equation:

\begin{equation}
  \pmb{\hat{y}}[k] = \pmb{C_d} \Delta \hat{p}_{WT}[k] + \pmb{D_d} \pmb{\hat{u}}[k] + \pmb{K_d} \pmb{\hat{d}}[k]
\label{statespace_control_output_discrete}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $A_d \in \mathbb{R}^{(1 \times 1)}$ \\
\hspace*{8mm} $\pmb{B_d} \in \pmb{\mathbb{R}}^{(1 \times 2)}$ \\
\hspace*{8mm} $\pmb{E_d} \in \pmb{\mathbb{R}}^{(1 \times 2)}$ \\
\hspace*{8mm} $\pmb{C_d} \in \pmb{\mathbb{R}}^{(2 \times 1)}$ \\
\newline
\hspace*{8mm} $\pmb{D_d} \in \pmb{\mathbb{R}}^{(2 \times 2)}$ \\
\newline
\hspace*{8mm} $\pmb{K_d} \in \pmb{\mathbb{R}}^{(2 \times 2)}$ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
is the discrete state matrix, \\
is the discrete input matrix, \\
is the discrete disturbance matrix, \\ 
is the discrete output matrix, which is the same as in continuous case \\
is the discrete feed-forward matrix, which is the same as in continuous case \\
is the discrete disturbance matrix affecting the output, which is the same as in continuous case \\
\end{minipage}

