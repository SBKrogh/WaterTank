\section{Model for the Parameter Estimation}  
\label{ParameterEstimation}
Once the corresponding incidence and cycle matrix have been identified and the analogy between hydraulic and
electrical circuits has been made, it is possible to derive a model for the hydraulic network. 

In the parameter estimation the WT will be discarded from the hydraulic system, 
in order to facilitate the process of estimation. Consequently, the WT will be isolated from the other components of the
system.  



In \secref{IncidenceSection} the form of the incidence matrix has been shown. It is worth mentioning that the last column of the H matrix agrees with the WT edge. Hence, the H matrix can be written as 
% It is worth mentioning that it is been also followed the structure such as the last 
% column of the H matrix agrees with the WT edge. Hence, the H matrix can 
% be written as

\begin {equation}
H = [H_1 \quad H_0]
\label{Hmatrix}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $H_1 \epsilon \mathbb{R}^{n \times e-1}$  \\
\hspace*{8mm} $H_0 \epsilon \mathbb{R}^{n \times 1} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the H matrix without the edge corresponding to the WT\\
\hspace*{4mm} is the H matrix with the column corresponding to the WT 
\end{minipage}

In the same way, the fundamental cycle matrix, B, has been structured such as the last column agrees with the WT edge.

\begin{equation}
  B = [B_1 \quad B_0]
\end{equation} 

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $B_1 \epsilon \mathbb{R}^{l \times e-1}$  \\
\hspace*{8mm} $B_0 \epsilon \mathbb{R}^{l \times 1} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the B matrix without the edge corresponding to the WT\\
\hspace*{4mm} is the B matrix with the column corresponding to the WT 
\end{minipage}

As mentioned above, $q$ is a vector containing all the individual flows, which 
is re-structured as following

\begin{equation}
q =
\begin{bmatrix}
         q_1 \\
	q_0 
\end{bmatrix}
\label{qmatrix}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $q_1 \epsilon \mathbb{R}^{e-1 \times 1}$  \\
\hspace*{8mm} $q_0 \epsilon \mathbb{R} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the flow through all components expect for WT\\
\hspace*{4mm} is the flow through the WT 
\end{minipage}

The vector containing the pressures at the nodes is also re-structured as

\begin{equation}
p =
\begin{bmatrix}
         p_1 \\
	p_0 
\end{bmatrix}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $p_1 \epsilon \mathbb{R}^{n-1 \times 1}$  \\
\hspace*{8mm} $p_0 \epsilon \mathbb{R} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the pressure at all the nodes expect for WT\\
\hspace*{4mm} is the pressure in the WT 
\end{minipage}

In \eqref{KCL} KCL law is applied for a connected directed graph, where it is stated that the sum of all the flows entering 
into a node must be equal the the sum of all the nodes out of the node.

By choosing an independent set of flows, corresponding to the chords of a spanning tree, the 
flow through every edge of the hydraulic system can be expressed in terms of the flow through the chords, $z$ \cite{GraphModel}.
Thus, reducing the number of unknowns in the system. These elements of $z$ are called the free 
flows of the system and are independent variables \cite{GraphTheoryCarsten}.

\begin{equation}
  q_1 = B_1 ^{T}  z
  \label{ChordRelation}
\end{equation}

In order to extract the component model into a more generalized form, it is rewritten as a function of flow, $q_1$, angular velocity, $\omega$, and conductivity factor, $k_v$ as follows:

\begin{equation}
  \tilde{f}_i(q_1, \omega, k_v) = \lambda_i(q_1) + \zeta_i + \nu_i(q_1, k_v) - \alpha_i(\omega)
  \label{ComponentFunction}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{2mm} $\tilde{f}_i = -C_{pi} q_i |q_i|$  \\
\hspace*{2mm} $\tilde{f}_i = -C_{vi} q_i |q_i|$  \\
\hspace*{2mm} $\tilde{f}_i = \Big(\frac{2}{k_{v100}^2} - a_{h2i}\Big)|q_i| q_i  + a_{h1i} \omega_{i} q_i + a_{h0i}{\omega_i}^2$  
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{25mm} if i = 2,3,4,5,6,7,10,11,12,14,17,18,19,21,23\\
\hspace*{25mm} if i = 13,15,20,22						   \\
\hspace*{65mm} if i = 1,8,9,16						   
\end{minipage}

\todo{Fixe structuring error}

The following hydraulic network model shows an overall model along with the above considerations. 
Now recall that the inertia matrix, J, was defined in \secref{CompletePipe}.

\begin{equation}
  \Delta p_1 =  J \dot{q}_1 + f(q_1, w, k_v)
  \label{NoTowerModel}
\end{equation}

In \eqref{NoTowerModel} the hydraulic network model is described in terms of the 
flow through all the nodes. In order to reduce the order of the model and hence, 
the amount of unknowns \eqref{ChordRelation} is applied. 

\begin{equation}
  \Delta p_1 =  J {B_1}^T \dot{z} + f(z, w, k_v)
  \label{ChordsModel}
\end{equation}

Making use of the identity shown in \eqref{KVL}, the following is obtained

\begin{equation}
  0 = B_1 \Delta p_1 = B_1 [ J {B_1}^T \dot{z} + f(z, w, k_v)] 
 \end{equation}

Isolating the inertia matrix to the left side

\begin{equation}
 - B_1 J {B_1}^T \dot{z}  = B_1 f(z, w, k_v)
 \end{equation}

It is desired to know the value of the flow through the chords, hence the above equation is solved 
for $\dot{z}$. Nevertheless, in order to invert $(B_1 J {B_1}^T)$ it has to be nonsingular i.e. invertible. 

Setting $\mathcal{J} = B_1 J {B_1}^T $, for $\mathcal{J}$ to be positive-definite it has to be a square matrix and its 
determinant has to be nonzero. Observe that $\mathcal{J}$ is

\begin{equation}
  \label{Jequation}
  \mathcal{J} = (I \quad B_f) 
  \begin{pmatrix}
    J_c    &    0    \\
    0       &    J_f
  \end{pmatrix}
  \begin{pmatrix}
    I    \\
    {B_f}^T
  \end{pmatrix}
  = J_c + B_f J_f {B_f}^T
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $J_c \in \mathbb{R}^{l \times l}$  \\
\hspace*{8mm} $J_f \in \mathbb{R}^{f \times f} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the inertia in the chords components\\
\hspace*{4mm} is the inertia in the component of the spanning tree 
\end{minipage}

$J_c$ is the diagonal inertia matrix containing the chords elements,  since all 
the components corresponding to a chord in $\mathcal{G}$ are pipes, all the 
diagonal term are positive. Thus, $J_c > 0$. 

Nevertheless, if there would be at least a chord corresponding to a non-pipe element, \eqref{Jequation} 
will continue being positive-definite as long as there is a possibility to create a spanning tree containing all 
chord as pipes elements from $\mathcal{G}$ \cite{TowerModel}.

For the remaining term $B_f J_f {B_f}^T$, $J_f$ is non-negative matrix as all its elements are zero or pipeÂ´s inertia. 
Multiplying $B_f J_f {B_f}^T$ by a non-zero vector column $\mathbf{x}$ and its transpose $\mathbf{x^{T}}$

\begin{equation}
  \mathbf{x^{T}} B_f J_f {B_f}^T \mathbf{x}
  \label{PosDefi}
\end{equation}

Creating a new variable $y = {B_f}^T \mathbf{x}$ and applying the positive semi-definite matrix definition 
\cite{MatrixBook}

\begin{equation}
  y^{T} J_f y \geqslant 0
  \label{PosDefEq}
\end{equation}

Thus, \eqref{Jequation} is positive definite a sufficient condition for $\mathcal{J}$ being invertible. 

Therefore, the system model can be written as follows

\begin{equation}
   \dot{z}  = - (B_1 J {B_1}^T)^{-1}B_1 f(z, w, k_v)
   \label{ParatModelFinal}
 \end{equation}

\subsection{Model Relations}
\label{ModelRelationSection}

As a consequence of the system model established above, a new set of relations for the parameter estimation can be 
obtained. Starting from the component complete model

\begin{equation}
  \Delta p_1 =  J \dot{q}_1 + f(q_1, w, k_v)
  \label{RecallModel}
\end{equation}

Recall that previously, in \eqref{ChordRelation}, a new state, $z$, has been defined for the independent flows in 
the graph

\begin{equation}
  \Delta p_1 =  J {B_1}^T \dot{z} + f(z, w, k_v)
 \end{equation}

The flow rate through the chords is found in \eqref{ParatModelFinal}, thus the expression for $ \Delta p_1 $ can be rewritten as

\begin{equation}
  \Delta p_1 =  J {B_1}^T [- (B_1 J {B_1}^T)^{-1}B_1 f(z, w, k_v)] + f(z, w, k_v)
  \label{PressureLarge}
 \end{equation}
 
 Rewritten it in a shorter form
 
 \begin{equation}
  \Delta p_1 =  (-J {B_1}^T (B_1 J {B_1}^T)^{-1}B_1 + \mathcal{I}) f(z, w, k_v)
  \label{PressureShort}
 \end{equation}




