\section{Network model}  
\label{ParameterEstimation}
Once the corresponding incidence and cycle matrices are identified and the analogy between hydraulic and electrical circuits is concluded, the whole hydraulic network can be described in a compact, generalized form as a set of differential equations describing the system. In this section an abstract and general form of the network model is derived using all the previously obtained expressions. 
\\
In \secref{IncidenceSection}, the form of the incidence matrix is shown. The last column of $\pmb{H}$ represents the edge that belongs to the WT. (In case of the network, the number of edges representing the WT is one and in the further model description is denoted with $w$.) 
\\
Hence, the $\pmb{H}$ matrix can be written as 
% It is worth mentioning that it is been also followed the structure such as the last 
% column of the H matrix agrees with the WT edge. Hence, the H matrix can 
% be written as

\begin {equation}
\pmb{H} = [\pmb{H_1} \quad \pmb{H_0}]
\label{Hmatrix}
\end{equation}

\begin{minipage}[t]{0.18\textwidth}
Where\\
\hspace*{8mm} $\pmb{H_1} \in \: \mathbb{R}^{n \times (e-w)}$  \\
and \hspace*{0.4mm} $\pmb{H_0} \in \: \mathbb{R}^{n \times w} $ 
\end{minipage}
\begin{minipage}[t]{0.70\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the $\pmb{H}$ matrix without the edge corresponding to the WT,\\
\hspace*{4mm} is the $\pmb{H}$ matrix with the column corresponding to the WT. 
\end{minipage}

Similarly, the fundamental cycle matrix, B, is structured such as the last column agrees with the edge representing the WT.

\begin{equation}
  \pmb{B} = [\pmb{B_1} \quad \pmb{B_0}]
\end{equation} 

\begin{minipage}[t]{0.18\textwidth}
Where\\
\hspace*{8mm} $\pmb{B_1} \: \in \mathbb{R}^{l \times (e-w)}$  \\
and \hspace*{0.4mm} $\pmb{B_0} \: \in \mathbb{R}^{l \times w} $ 
\end{minipage}
\begin{minipage}[t]{0.70\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the $\pmb{B}$ matrix without the edge corresponding to the WT,\\
\hspace*{4mm} is the $\pmb{B}$ matrix with the column corresponding to the WT.
\end{minipage}

As mentioned above, $\pmb{q}$ is a vector containing all the individual flows, which can be structured as follows:

\begin{equation}
\pmb{q} =
\begin{bmatrix}
         \pmb{q_1} \\
	\pmb{q_0} 
\end{bmatrix}
\label{qmatrix}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $\pmb{q_1} \in \mathbb{R}^{(e-w) \times 1}$  \\
\hspace*{8mm} $\pmb{q_0} \in \mathbb{R}^{w \times 1} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the flow through all edges expect for WT,\\
\hspace*{4mm} is the flow through the edge belonging to the WT. 
\end{minipage}

The vector containing the pressures at the nodes can be also structured as

\begin{equation}
\pmb{p} =
\begin{bmatrix}
         \pmb{p_1} \\
	\pmb{p_0} 
\end{bmatrix}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $\pmb{p_1} \in \mathbb{R}^{(n-w) \times 1}$  \\
\hspace*{8mm} $\pmb{p_0} \in \mathbb{R}^{w \times 1} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the pressure at all nodes expect for the WT,\\
\hspace*{4mm} is the pressure in the WT.
\end{minipage}

In \eqref{KCL} KCL is applied to $\mathcal{G}$, which states that the sum of all the flows entering into a node must be equal to the sum of all the flows leaving the node.

By choosing independent set of flows corresponding to the chords of a spanning tree, the flow through every edge of the hydraulic system can be expressed in terms of the flow through the chords, $z$ \cite{GraphModel}.
The chord flows make it possible to deal with less variables, thus making the set of differential equations easier to handle.  The elements of $\pmb{z}$ are called the free flows of the system and are independent from each other, as mentioned previously \cite{GraphTheoryCarsten}.

\begin{equation}
  \pmb{q_i} = \pmb{B_i} ^{T}  \pmb{z}
  \label{ChordRelation}
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $\pmb{z} \in \mathbb{R}^{(1 \times g)} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the chord flow vector and g is the number of elements.
\end{minipage}

As it is shown in \eqref{ChordRelation}, the $i^{th}$ flow in the system is defined by the $i^{th}$ column of the cycle matrix and the vector of chord flows, $z$. 
\\
Before writing up an expression that describes all parts, the component model in \eqref{CompleteModel} needs to be modified because of the simplifications introduced in \secref{SystemModel}. As it is mentioned in that section, there are four pumps in the system, two main and two PMA pumps, which provide pressure according to the input signals given to them. However there is one case between ($n_3$-$n_{18}$), where the model of the pump is plugged into the model of the valves and considered as an additional resistance without the pump being turned on. In this case the corresponding edge does not act as an input but can be described by \eqref{omega_zero}. Therefore \eqref{CompleteModel} is structured in such a way that the edge corresponding to the connection between the WT and the system is represented respectively. The component-wise expression can be written as follows:

\begin{equation}
\label{CompleteModel_extended}
\Delta p_i = \underbrace{\lambda_i (q_i) + \zeta_i + J_i \dot{q_i}}_\text{Pipe} + \underbrace{\mu_i (q_i, k_{v;i})}_\text{Valve} - \underbrace{\tilde{\alpha}_i(u_i)}_\text{Pump+valves} + \underbrace{\Delta p_{WT;i}}_\text{Water tank} + \underbrace{\gamma_i (q_i)}_\text{WT-connection}
\end{equation}

%In order to extract the component model into a more generalized form, it is rewritten as a function of flow, $\pmb{q_1}$, angular velocity, $\omega$, and opening degree of the valves, $OD$ as follows:

\begin{equation}
  \tilde{f}_i(\pmb{q_{i}}, \pmb{\omega_i}, \pmb{k_v}) = \lambda_i(\pmb{q_{i}}) + \zeta_i + \mu_i(\pmb{q_{i}}, \pmb{k_v}) - \tilde{\alpha}_i(\pmb{\omega_i}) + \gamma_i (\pmb{q_i})
  \label{ComponentFunction}
\end{equation}

Where\\
\begin{align}
\tilde{f}_i &= -\pmb{C_{pi} q_i} |\pmb{q_i}|  \hskip 2cm  \text{for}\: i = 2,3,4,5,6,7,10,11,12,14,17,18,19,21,23 \\
\tilde{f}_i &= -\pmb{C_{vi} q_i} |\pmb{q_i}|  \hskip 2cm  \text{for}\:i = 13,15,20,22\\
\tilde{f}_i &= \Big(\frac{2}{k_{v100}^2} - a_{h2i}\Big)|\pmb{q_i}| \pmb{q_i}  + a_{h1i} \pmb{\omega_{i}} \pmb{q_i} + a_{h0i}\pmb{{\omega_i}}^2 \hskip 2cm  \text{for}\: i = 1,8,9,16 \\
\tilde{f}_i &= \Big(\frac{2}{k_{v100}^2} - a_{h2i}\Big)|\pmb{q_i}| \pmb{q_i}  \hskip 2cm  \text{for}\: i = 24 \\
\tilde{f}_i &= \Delta p_{WT}  \hskip 2cm  \text{for}\:i = 25
\end{align}

The following hydraulic network model shows an overall model along with the above-mentioned considerations. 
Now recall that the inertia matrix, J, was defined in \secref{CompletePipe}.

\begin{equation}
  \pmb{\Delta p_1} =  \pmb{J} \pmb{\dot{q}_1} + \tilde{f}(\pmb{q_1}, \pmb{w}, \pmb{k_v})
  \label{NoTowerModel}
\end{equation}

In \eqref{NoTowerModel} the hydraulic network model is described in terms of the 
flow through all the nodes. In order to reduce the order of the model and hence, 
the amount of unknowns, the chord flows according to \eqref{ChordRelation} are applied. 

\begin{equation}
  \Delta \pmb{p_1} =  \pmb{J} {\pmb{B_1}}^T \pmb{\dot{z}} + f({\pmb{B_1}}^T \pmb{z}, \pmb{w}, \pmb{k_v})
  \label{ChordsModel}
\end{equation}

Making use of the identity shown in \eqref{KVL}, the following is obtained

\begin{equation}
  0 = \pmb{B_1} \pmb{\Delta p_1} = \pmb{B_1} [ \pmb{J {B_1}}^T \pmb{\dot{z}} + f({\pmb{B_1}}^T \pmb{z}, \pmb{w}, \pmb{k_v})] 
 \end{equation}

Isolating the inertia matrix to the left side

\begin{equation}
 - \pmb{B_1} \pmb{J} \pmb{{B_1}}^T \pmb{\dot{z}}  = \pmb{B_1} f({\pmb{B_1}}^T \pmb{z}, \pmb{w}, \pmb{k_v})
 \label{isolateZ}
 \end{equation}

It is desired to know the value of the flow through the chords, hence the equation above is solved 
for $\pmb{\dot{z}}$. In order to invert $(\pmb{B_1 J} \pmb{{B_1}}^T)$ it has to be non-singular i.e. invertible. 

Setting $\pmb{\mathcal{J}} = \pmb{B_1 J} \pmb{{B_1}}^T $, for $\pmb{\mathcal{J}}$ to be positive-definite it has to be a square matrix and its 
determinant has to be non-zero. Note that $\pmb{\mathcal{J}}$ is

\begin{equation}
  \label{Jequation}
  \pmb{\mathcal{J}} = (\pmb{I \quad B_f}) 
  \begin{pmatrix}
    \pmb{J_c}    &    \pmb{0 }   \\
    \pmb{0}       &   \pmb{ J_f}
  \end{pmatrix}
  \begin{pmatrix}
    \pmb{I}    \\
    \pmb{{B_f}}^T
  \end{pmatrix}
  = \pmb{J_c} + \pmb{B_f J_f} \pmb{{B_f}}^T
\end{equation}

\begin{minipage}[t]{0.20\textwidth}
Where\\
\hspace*{8mm} $\pmb{J_c} \in \mathbb{R}^{l \times l}$  \\
\hspace*{8mm} $\pmb{J_f} \in \mathbb{R}^{f \times f} $ 
\end{minipage}
\begin{minipage}[t]{0.68\textwidth}
\vspace*{2mm}
\hspace*{4mm} is the inertia in the chord components\\
\hspace*{4mm} is the inertia in the components of the spanning tree 
\end{minipage}

$\pmb{J_c}$ is a diagonal inertia matrix containing the chord elements. Since all the components corresponding to a chord in $\pmb{\mathcal{G}}$ are pipes, all the 
diagonal terms are positive. Thus, $\pmb{J_c} > 0$. 

Nevertheless, if there is at least a chord corresponding to a non-pipe element, \eqref{Jequation} 
would be positive-definite as long as it is possible to create a spanning tree containing all chords as pipe elements from $\pmb{\mathcal{G}}$ \cite{TowerModel}.

For the remaining term $\pmb{B_f J_f {B_f}}^T$, $\pmb{J_f}$ is a non-negative matrix as all its elements are zero or describe the inertia of a pipe. 
Multiplying $\pmb{B_f J_f {B_f}}^T$ by a non-zero vector column $\mathbf{x}$ and its transpose $\mathbf{x}^{T}$

\begin{equation}
  \pmb{x}^{T} \pmb{B_f J_f {B_f}}^T \pmb{x}
  \label{PosDefi}
\end{equation}

Creating a new variable $\pmb{y} = \pmb{B_f}^T \mathbf{x}$ and applying the definition of positive semi-definiteness 
\cite{MatrixBook}

\begin{equation}
  \pmb{y}^{T} \pmb{J_f y} \geqslant 0
  \label{PosDefEq}
\end{equation}

Thus, \eqref{Jequation} is positive definite and it provides a sufficient condition for $\pmb{\mathcal{J}}$ being invertible. 

Therefore, the system can be described as follows

\begin{equation}
   \pmb{\dot{z}}  = - (\pmb{B_1 J {B_1}}^T)^{-1}\pmb{B_1} f({\pmb{B_1}}^T \pmb{z},\pmb{ w}, \pmb{k_v})
   \label{ParatModelFinal}
 \end{equation}

\subsection{Pressure drop across the nodes}
\label{ModelRelationSection}

For ease of reading, the complete component model in \eqref{NoTowerModel} is restated: 

\begin{equation}
  \pmb{\Delta p_1} =  \pmb{J} \pmb{\dot{q}_1} + \tilde{f}(\pmb{q_1}, \pmb{w}, \pmb{k_v})
  \label{RecallModel}
\end{equation}

This equation describes the system by the pressure of across each elements except the part including the water tower. The dynamics are determined by the inertia of the pipes, while the pressure relations are described by f vectorfield. 
The same equation can be however expressed with a reduced set of equation system with the help of chord flows: 

\begin{equation}
  \pmb{\Delta p_1} =  \pmb{J {B_1}}^T \pmb{\dot{z}} + f({\pmb{B_1}}^T \pmb{z}, \pmb{w}, \pmb{k_v})
 \end{equation}

The flow rate through the chords is found in \eqref{ParatModelFinal}, thus the expression for $ \pmb{\Delta p_1} $ can be rewritten as

\begin{equation}
 \pmb{ \Delta p_1} = \pmb{ J {B_1}}^T [- (\pmb{B_1 J {B_1}}^T)^{-1}\pmb{B_1} f({\pmb{B_1}}^T \pmb{z},\pmb{ w}, \pmb{k_v})] + f({\pmb{B_1}}^T \pmb{z},\pmb{ w}, \pmb{k_v})
  \label{PressureLarge}
 \end{equation}
 
Writing in short form:
 
 \begin{equation}
  \pmb{\Delta p_1} =  (-\pmb{J {B_1}}^T (\pmb{B_1 J {B_1}}^T)^{-1}\pmb{B_1} + \pmb{\mathcal{I}}) f({\pmb{B_1}}^T \pmb{z}, \pmb{w}, \pmb{k_v})
  \label{PressureShort}
 \end{equation}

a general form of the network without the part corresponding to the WT ($\pmb{p_0}$ and $\pmb{q_0}$) is obtained. It should be noted however, that the same structure applies for the complete network which is extended with the WT. In the following sections this general model is used in a slightly different form that is suitable for the different estimation methods. 


